create table public.trades (
  id text primary key,
  "orderId" text,
  symbol text,
  side text,
  quantity numeric,
  price numeric,
  timestamp bigint,
  status text default 'OPEN',
  commission numeric,
  "commissionAsset" text,
  "stopLossPrice" numeric,
  "takeProfitPrice" numeric,
  "exitPrice" numeric,
  "exitTimestamp" bigint,
  "exitReason" text,  -- Reason for closing the trade (e.g., STOP_LOSS, TAKE_PROFIT, TRAILING_STOP_LOSS, STRATEGY_EXIT)
  "strategyName" text,  -- Name of the strategy that opened this trade
  leverage numeric,
  margin numeric,
  duration bigint,
  -- Trailing Stop Loss fields
  "trailingStopEnabled" boolean,
  "trailingStopActivated" boolean,
  "trailingStopActivationPercent" numeric,
  "trailingStopTrailPercent" numeric,
  "trailingStopHighPrice" numeric,  -- For BUY positions: highest price seen
  "trailingStopLowPrice" numeric,   -- For SELL positions: lowest price seen
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- Portfolio Snapshots
create table public.portfolio_snapshots (
  id bigint generated by default as identity primary key,
  timestamp bigint,
  "totalValue" numeric,
  holdings jsonb,
  pnl numeric,
  "pnlPercentage" numeric,
  "winRate" numeric,
  "profitFactor" numeric,
  "winningTrades" integer,
  "losingTrades" integer,
  "openTradesCount" integer,
  "currentEquity" numeric,
  "currentBalance" numeric,
  "walletBalance" numeric,
  "totalMarginUsed" numeric,
  "totalNotionalValue" numeric,
  "initialBalance" numeric,
  created_at timestamp with time zone default timezone('utc'::text, now())
);
create index if not exists idx_portfolio_snapshots_timestamp on public.portfolio_snapshots (timestamp desc);
 
-- Portfolio Chart Cache (Optimized for instant dashboard loading)
create table public.portfolio_chart_cache (
  period text primary key, -- e.g. '1d', '1w', '1m', '1y', 'all'
  data jsonb not null, -- Array of {timestamp, equity} points
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- Backtest Results
create table public.backtest_results (
  id bigint generated by default as identity primary key,
  timestamp bigint,
  result jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- Application State Persistence
create table public.kv_store (
  key text primary key,
  value jsonb not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);
comment on table public.kv_store is 'Generic key-value store for persisting application state (e.g. risk limits)';

-- Vault Transactions Table
CREATE TABLE IF NOT EXISTS public.vault_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email TEXT NOT NULL,
    amount NUMERIC NOT NULL,
    shares NUMERIC NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('DEPOSIT', 'WITHDRAWAL')),
    timestamp BIGINT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- Vault State Table (Singleton)
CREATE TABLE IF NOT EXISTS public.vault_state (
    id INT PRIMARY KEY DEFAULT 1,
    total_assets NUMERIC DEFAULT 0,
    total_shares NUMERIC DEFAULT 0,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
    CONSTRAINT singleton CHECK (id = 1)
);

-- Add vault-related comments
COMMENT ON TABLE public.vault_transactions IS 'Logs all deposits and withdrawals from the paper trading vault';
COMMENT ON TABLE public.vault_state IS 'Real-time summary of the vault total value and total issued shares';

-- ============================================================================
-- ROW LEVEL SECURITY (RLS) POLICIES
-- ============================================================================

-- Enable RLS on all tables
ALTER TABLE public.trades ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.portfolio_snapshots ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.portfolio_chart_cache ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.backtest_results ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.kv_store ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.vault_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.vault_state ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- TRADES TABLE POLICIES
-- ============================================================================

-- Allow authenticated users to read all trades
CREATE POLICY "Allow authenticated read access to trades"
  ON public.trades
  FOR SELECT
  TO authenticated
  USING (true);

-- Allow authenticated users to insert trades
CREATE POLICY "Allow authenticated insert access to trades"
  ON public.trades
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Allow authenticated users to update trades
CREATE POLICY "Allow authenticated update access to trades"
  ON public.trades
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- Allow authenticated users to delete trades
CREATE POLICY "Allow authenticated delete access to trades"
  ON public.trades
  FOR DELETE
  TO authenticated
  USING (true);

-- ============================================================================
-- PORTFOLIO SNAPSHOTS TABLE POLICIES
-- ============================================================================

-- Allow authenticated users to read all portfolio snapshots
CREATE POLICY "Allow authenticated read access to portfolio_snapshots"
  ON public.portfolio_snapshots
  FOR SELECT
  TO authenticated
  USING (true);

-- Allow authenticated users to insert portfolio snapshots
CREATE POLICY "Allow authenticated insert access to portfolio_snapshots"
  ON public.portfolio_snapshots
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Allow authenticated users to update portfolio snapshots
CREATE POLICY "Allow authenticated update access to portfolio_snapshots"
  ON public.portfolio_snapshots
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- Allow authenticated users to delete portfolio snapshots
CREATE POLICY "Allow authenticated delete access to portfolio_snapshots"
  ON public.portfolio_snapshots
  FOR DELETE
  TO authenticated
  USING (true);

-- ============================================================================
-- PORTFOLIO CHART CACHE TABLE POLICIES
-- ============================================================================

-- Allow authenticated users to read chart cache
CREATE POLICY "Allow authenticated read access to portfolio_chart_cache"
  ON public.portfolio_chart_cache
  FOR SELECT
  TO authenticated
  USING (true);

-- Allow authenticated users to insert chart cache
CREATE POLICY "Allow authenticated insert access to portfolio_chart_cache"
  ON public.portfolio_chart_cache
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Allow authenticated users to update chart cache
CREATE POLICY "Allow authenticated update access to portfolio_chart_cache"
  ON public.portfolio_chart_cache
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- Allow authenticated users to delete chart cache
CREATE POLICY "Allow authenticated delete access to portfolio_chart_cache"
  ON public.portfolio_chart_cache
  FOR DELETE
  TO authenticated
  USING (true);

-- ============================================================================
-- BACKTEST RESULTS TABLE POLICIES
-- ============================================================================

-- Allow authenticated users to read backtest results
CREATE POLICY "Allow authenticated read access to backtest_results"
  ON public.backtest_results
  FOR SELECT
  TO authenticated
  USING (true);

-- Allow authenticated users to insert backtest results
CREATE POLICY "Allow authenticated insert access to backtest_results"
  ON public.backtest_results
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Allow authenticated users to update backtest results
CREATE POLICY "Allow authenticated update access to backtest_results"
  ON public.backtest_results
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- Allow authenticated users to delete backtest results
CREATE POLICY "Allow authenticated delete access to backtest_results"
  ON public.backtest_results
  FOR DELETE
  TO authenticated
  USING (true);

-- ============================================================================
-- KV STORE TABLE POLICIES
-- ============================================================================

-- Allow authenticated users to read kv_store
CREATE POLICY "Allow authenticated read access to kv_store"
  ON public.kv_store
  FOR SELECT
  TO authenticated
  USING (true);

-- Allow authenticated users to insert kv_store
CREATE POLICY "Allow authenticated insert access to kv_store"
  ON public.kv_store
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Allow authenticated users to update kv_store
CREATE POLICY "Allow authenticated update access to kv_store"
  ON public.kv_store
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- Allow authenticated users to delete kv_store
CREATE POLICY "Allow authenticated delete access to kv_store"
  ON public.kv_store
  FOR DELETE
  TO authenticated
  USING (true);

-- ============================================================================
-- VAULT TRANSACTIONS TABLE POLICIES
-- ============================================================================

-- Allow authenticated users to read vault transactions
CREATE POLICY "Allow authenticated read access to vault_transactions"
  ON public.vault_transactions
  FOR SELECT
  TO authenticated
  USING (true);

-- Allow authenticated users to insert vault transactions
CREATE POLICY "Allow authenticated insert access to vault_transactions"
  ON public.vault_transactions
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Allow authenticated users to update vault transactions
CREATE POLICY "Allow authenticated update access to vault_transactions"
  ON public.vault_transactions
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- Allow authenticated users to delete vault transactions
CREATE POLICY "Allow authenticated delete access to vault_transactions"
  ON public.vault_transactions
  FOR DELETE
  TO authenticated
  USING (true);

-- ============================================================================
-- VAULT STATE TABLE POLICIES
-- ============================================================================

-- Allow authenticated users to read vault state
CREATE POLICY "Allow authenticated read access to vault_state"
  ON public.vault_state
  FOR SELECT
  TO authenticated
  USING (true);

-- Allow authenticated users to insert vault state
CREATE POLICY "Allow authenticated insert access to vault_state"
  ON public.vault_state
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Allow authenticated users to update vault state
CREATE POLICY "Allow authenticated update access to vault_state"
  ON public.vault_state
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- Allow authenticated users to delete vault state
CREATE POLICY "Allow authenticated delete access to vault_state"
  ON public.vault_state
  FOR DELETE
  TO authenticated
  USING (true);
